# ๐ ุฏููู ุงุณุชุฑุฏุงุฏ ุงูุงุดุชุฑุงู (Restore Purchases)

## ุงููุดููุฉ ุงูุชู ุชู ุญููุง

**ูุจู ุงูุชุญุฏูุซ:**
- RevenueCat ูุงู ูุณุชุฎุฏู Anonymous ID
- ุนูุฏ ุญุฐู ุงูุชุทุจูู ุฃู ุชุบููุฑ ุงูุฌูุงุฒุ RevenueCat ููุดุฆ Anonymous ID ุฌุฏูุฏ
- ุงูุงุดุชุฑุงู ูุฑุชุจุท ุจู Anonymous ID ุงููุฏูู โ **ูููุฏ ุงููุณุชุฎุฏู ุงูุงุดุชุฑุงู** โ

**ุจุนุฏ ุงูุชุญุฏูุซ:**
- RevenueCat ูุฑุจูุท ุจู Supabase `user_id` ุจุฏูุงู ูู Anonymous ID
- ุงูุงุดุชุฑุงู ูุญููุธ ูู Supabase ุฃูุถุงู
- ุนูุฏ ุงุณุชุฑุฏุงุฏ ุงููุดุชุฑูุงุชุ ูุชุญูู ูู Supabase ุฃููุงู ุซู RevenueCat
- **ุงููุณุชุฎุฏู ูุณุชุทูุน ุงุณุชุฑุฏุงุฏ ุงูุงุดุชุฑุงู ุนูู ุฃู ุฌูุงุฒ** โ

---

## ููู ูุนูู ุงููุธุงู ุงูุขู

### 1. ุนูุฏ ุงูุดุฑุงุก ุงูุฃูู

```
1. ุงููุณุชุฎุฏู ูุดุชุฑู ุงุดุชุฑุงู ูู RevenueCat
   โ
2. RevenueCat ูุณุชุฎุฏู Supabase user_id ูู Customer ID
   โ
3. ูุชู ุญูุธ:
   - ุงูุงุดุชุฑุงู ูู RevenueCat (ูุฑุจูุท ุจู Supabase user_id)
   - ุญุงูุฉ ุงูุงุดุชุฑุงู ูู Supabase (is_pro = TRUE)
   - RevenueCat Customer ID ูู Supabase (revenuecat_customer_id)
```

### 2. ุนูุฏ ุญุฐู ุงูุชุทุจูู ุฃู ุชุบููุฑ ุงูุฌูุงุฒ

```
1. ุงููุณุชุฎุฏู ูุญุฐู ุงูุชุทุจูู ุฃู ูุบูุฑ ุงูุฌูุงุฒ
   โ
2. ุนูุฏ ุฅุนุงุฏุฉ ุงูุชุซุจูุช:
   - ุงูุชุทุจูู ูุณุฌู ุฏุฎูู ุชููุงุฆูุงู (Anonymous Auth)
   - Supabase ููุดุฆ ููุณ user_id (ูุฃูู ููุณ ุงูุฌูุงุฒ/ุญุณุงุจ)
   โ
3. ุนูุฏ ูุชุญ ุงูุชุทุจูู:
   - RevenueCat ูุฑุจุท Supabase user_id ุชููุงุฆูุงู
   - ูุชุญูู ูู Supabase โ ูุฌุฏ ุงูุงุดุชุฑุงู โ
   - ูุชุญูู ูู RevenueCat โ ูุฌุฏ ุงูุงุดุชุฑุงู โ
```

### 3. ุนูุฏ ุงุณุชุฑุฏุงุฏ ุงููุดุชุฑูุงุช ูุฏููุงู

```
1. ุงููุณุชุฎุฏู ูุถุบุท "ุงุณุชุนุงุฏุฉ ุงููุดุชุฑูุงุช"
   โ
2. ุงููุธุงู ูุชุญูู ูู:
   ุฃ) Supabase ุฃููุงู:
      - ุฅุฐุง ูุงู is_pro = TRUE โ โ ูุนูุฏ ุงูุงุดุชุฑุงู
   ุจ) RevenueCat ุซุงููุงู:
      - ูุญุงูู ุฑุจุท RevenueCat customer ID ุงููุญููุธ
      - ูุณุชุฑุฏ ุงูุงุดุชุฑุงู ูู RevenueCat
      - ูุฒุงูู ุฅูู Supabase
```

---

## ุงูุชุบููุฑุงุช ุงูุชูููุฉ

### 1. ุฅุถุงูุฉ ุญูู ุฌุฏูุฏ ูู `user_profiles`

```sql
revenuecat_customer_id TEXT
```

**ุงูุบุฑุถ:** ุญูุธ RevenueCat Customer ID ูุฑุจุทู ูุน Supabase user_id

### 2. ุฑุจุท RevenueCat ูุน Supabase user_id

**ูุจู:**
```dart
..appUserID = null, // Anonymous ID
```

**ุจุนุฏ:**
```dart
..appUserID = supabaseUserId, // Supabase user_id
```

### 3. ุญูุธ RevenueCat Customer ID

ุนูุฏ ุงูุดุฑุงุกุ ูุชู ุญูุธ:
- ุญุงูุฉ ุงูุงุดุชุฑุงู ูู Supabase (`is_pro = TRUE`)
- RevenueCat Customer ID ูู Supabase (`revenuecat_customer_id`)

### 4. ุงุณุชุฑุฏุงุฏ ูุญุณูู

`restorePurchases()` ุงูุขู:
1. ูุชุญูู ูู Supabase ุฃููุงู
2. ูุญุงูู ุฑุจุท RevenueCat customer ID ุงููุญููุธ
3. ูุณุชุฑุฏ ูู RevenueCat
4. ูุฒุงูู ุฅูู Supabase

---

## ุงูุณููุงุฑูููุงุช ุงููุฏุนููุฉ

### โ ุงูุณููุงุฑูู 1: ุญุฐู ุงูุชุทุจูู ูุฅุนุงุฏุฉ ุงูุชุซุจูุช

**ุงูุฎุทูุงุช:**
1. ุงููุณุชุฎุฏู ูุดุชุฑู ุงุดุชุฑุงู
2. ุงููุณุชุฎุฏู ูุญุฐู ุงูุชุทุจูู
3. ุงููุณุชุฎุฏู ูุนูุฏ ุชุซุจูุช ุงูุชุทุจูู
4. ุงูุชุทุจูู ูุณุฌู ุฏุฎูู ุชููุงุฆูุงู (ููุณ Supabase user_id)
5. **ุงูุงุดุชุฑุงู ูุนูู ุชููุงุฆูุงู** โ

### โ ุงูุณููุงุฑูู 2: ุชุบููุฑ ุงูุฌูุงุฒ (ููุณ ุงูุญุณุงุจ)

**ุงูุฎุทูุงุช:**
1. ุงููุณุชุฎุฏู ูุดุชุฑู ุงุดุชุฑุงู ุนูู ุงูุฌูุงุฒ ุงูุฃูู
2. ุงููุณุชุฎุฏู ูุซุจุช ุงูุชุทุจูู ุนูู ุฌูุงุฒ ุฌุฏูุฏ
3. ุงูุชุทุจูู ูุณุฌู ุฏุฎูู ุชููุงุฆูุงู (ููุณ Supabase user_id)
4. **ุงูุงุดุชุฑุงู ูุนูู ุชููุงุฆูุงู** โ

### โ ุงูุณููุงุฑูู 3: ุงุณุชุฑุฏุงุฏ ูุฏูู

**ุงูุฎุทูุงุช:**
1. ุงููุณุชุฎุฏู ููุชุญ ุงูุชุทุจูู
2. ุงููุณุชุฎุฏู ูุถุบุท "ุงุณุชุนุงุฏุฉ ุงููุดุชุฑูุงุช"
3. ุงููุธุงู ูุชุญูู ูู Supabase โ ูุฌุฏ ุงูุงุดุชุฑุงู โ
4. ุฃู ูุชุญูู ูู RevenueCat โ ูุณุชุฑุฏ ุงูุงุดุชุฑุงู โ

### โ ุงูุณููุงุฑูู 4: ููุฏุงู ุงูููุจุงูู

**ุงูุฎุทูุงุช:**
1. ุงููุณุชุฎุฏู ูุดุชุฑู ุงุดุชุฑุงู ุนูู ุงูููุจุงูู ุงูุฃูู (ุจุงุณุชุฎุฏุงู Apple/Google Account)
2. ุงููุณุชุฎุฏู ูููุฏ ุงูููุจุงูู
3. ุงููุณุชุฎุฏู ูุดุชุฑู ููุจุงูู ุฌุฏูุฏ ููุซุจุช ุงูุชุทุจูู
4. ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู ุจููุณ Apple/Google Account
5. ุงููุณุชุฎุฏู ูุถุบุท "ุงุณุชุนุงุฏุฉ ุงููุดุชุฑูุงุช"
6. RevenueCat ูุชุญูู ูู Apple/Google Account โ โ ูุฌุฏ ุงูุงุดุชุฑุงู
7. ุงููุธุงู ูุชุญูู ูู ููููุฉ ุงูุงุดุชุฑุงู โ โ ูุณููุญ
8. **ุงูุงุดุชุฑุงู ูุนูู** โ

**โ๏ธ ููู:** ูุฌุจ ุฃู ูููู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู ุจููุณ Apple/Google Account

---

## Migration SQL

### ุฅุฐุง ูุงู ุงูุฌุฏูู ููุฌูุฏุงู ูุณุจูุงู:

```sql
-- ุฅุถุงูุฉ ุญูู revenuecat_customer_id
ALTER TABLE public.user_profiles 
ADD COLUMN IF NOT EXISTS revenuecat_customer_id TEXT;

-- ุฅุถุงูุฉ index ููุจุญุซ ุงูุณุฑูุน
CREATE INDEX IF NOT EXISTS idx_user_profiles_revenuecat_customer_id 
ON public.user_profiles(revenuecat_customer_id) 
WHERE revenuecat_customer_id IS NOT NULL;
```

**ุฃู ุงุณุชุฎุฏู:**
- `supabase_migrations/add_subscription_fields.sql` (ุชู ุชุญุฏูุซู)

---

## ุงูุชุญูู ูู ุงูุนูู

### 1. ุชุญูู ูู ุงูุฌุฏูู:

```sql
SELECT 
  user_id, 
  is_pro, 
  subscription_type, 
  revenuecat_customer_id,
  subscription_expires_at
FROM public.user_profiles
WHERE is_pro = TRUE;
```

### 2. ุงุฎุชุจุฑ ูู ุงูุชุทุจูู:

1. **ุงุดุชุฑุงู:**
   - ุงุดุชุฑู ุงุดุชุฑุงู
   - ุชุญูู ูู Logs:
     ```
     โ RevenueCat Customer ID saved to Supabase: $RCAnonymousID:xxx
     โ Subscription synced to Supabase
     ```

2. **ุงุณุชุฑุฏุงุฏ:**
   - ุงุญุฐู ุงูุชุทุจูู
   - ุฃุนุฏ ุชุซุจูุชู
   - ุงูุชุญ ุงูุชุทุจูู
   - ุชุญูู ูู Logs:
     ```
     โ Linked existing RevenueCat customer: xxx
     โ Subscription status from Supabase: true
     ```

---

## ููุงุญุธุงุช ูููุฉ

### โ๏ธ Anonymous Authentication

**ููู ุฌุฏุงู:** ูุฌุจ ุชูุนูู Anonymous Authentication ูู Supabase:
- Supabase Dashboard โ Authentication โ Providers โ Anonymous
- ูุฌุจ ุฃู ูููู **ููุนูู** โ

**ุงูุณุจุจ:** ุงูุชุทุจูู ูุณุชุฎุฏู Anonymous Auth ูุฅูุดุงุก Supabase user_id ุชููุงุฆูุงู. ุจุฏูููุงุ ูู ูุนูู ุงูุฑุจุท.

### โ๏ธ RevenueCat Configuration

RevenueCat ุงูุขู ูุณุชุฎุฏู Supabase `user_id` ูู Customer ID:
- **ูุง ูุณุชุฎุฏู Anonymous ID** โ
- **ูุณุชุฎุฏู Supabase user_id** โ

### โ๏ธ Cross-Device Restore

**ูุนูู ููุท ุฅุฐุง:**
1. ุงููุณุชุฎุฏู ูุณุชุฎุฏู ููุณ Apple/Google Account ุนูู ุงูุฌูุงุฒ ุงูุฌุฏูุฏ โ
2. RevenueCat ูุชุญูู ุชููุงุฆูุงู ูู Apple/Google Account โ
3. ุงููุธุงู ูุชุญูู ูู ููููุฉ ุงูุงุดุชุฑุงู (ุญูุงูุฉ ูู ุงูุณุฑูุฉ) โ

**ูุง ูุนูู ุฅุฐุง:**
- ุงููุณุชุฎุฏู ูุณุชุฎุฏู Apple/Google Account ูุฎุชูู โ
- ุงูุงุดุชุฑุงู ูุฑุจูุท ุจู ุญุณุงุจ ุขุฎุฑ ูู Supabase โ
- Anonymous Auth ูุนุทู (ูู ูุนูู ุงูุงุณุชุฑุฏุงุฏ ุงูุชููุงุฆู ูู Supabase) โ

**๐ ุงูุฃูุงู:**
- RevenueCat ูุชุญูู ุชููุงุฆูุงู ูู Apple/Google Account
- ุงููุธุงู ูุชุญูู ูู ุฃู ุงูุงุดุชุฑุงู ูู ูุฑุจุท ุจุญุณุงุจ ุขุฎุฑ
- ุฅุฐุง ูุงู ุงูุงุดุชุฑุงู ูุฑุจูุท ุจุญุณุงุจ ุขุฎุฑ โ ุงูุงุณุชุฑุฏุงุฏ ูุฑููุถ (ุญูุงูุฉ ูู ุงูุณุฑูุฉ)

---

## ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ุงูุงุดุชุฑุงู ูุง ูุณุชุฑุฏ

**ุงูุญู:**
1. ุชุญูู ูู Anonymous Auth ูู Supabase
2. ุชุญูู ูู `revenuecat_customer_id` ูู Supabase:
   ```sql
   SELECT revenuecat_customer_id FROM user_profiles WHERE user_id = 'USER_ID';
   ```
3. ุชุญูู ูู Logs:
   ```
   โ Linked existing RevenueCat customer: xxx
   ```

### ุงููุดููุฉ: RevenueCat ูุง ูุฑุจุท

**ุงูุญู:**
1. ุชุญูู ูู ุฃู Supabase user_id ููุฌูุฏ
2. ุชุญูู ูู Logs:
   ```
   โ Linking RevenueCat to Supabase user: xxx
   ```

---

## ุงูุฎูุงุตุฉ

โ **ูุจู:** Anonymous ID โ ูููุฏ ุงูุงุดุชุฑุงู ุนูุฏ ุชุบููุฑ ุงูุฌูุงุฒ  
โ **ุจุนุฏ:** RevenueCat + Apple/Google Account โ ูุณุชุฑุฏ ุงูุงุดุชุฑุงู ุนุจุฑ ุงูุฃุฌูุฒุฉ

โ **ูุจู:** RevenueCat ููุท โ ูุนุชูุฏ ุนูู ุงูุฌูุงุฒ  
โ **ุจุนุฏ:** RevenueCat + ุงูุชุญูู ูู ุงูููููุฉ โ ูุนูู ุนูู ุฃู ุฌูุงุฒ ูุน ููุณ Apple/Google Account

โ **ุงูุฃูุงู:** ุงููุธุงู ูุชุญูู ูู ููููุฉ ุงูุงุดุชุฑุงู ูุจู ุงูุงุณุชุฑุฏุงุฏ (ุญูุงูุฉ ูู ุงูุณุฑูุฉ)

---

**ุชุงุฑูุฎ:** $(date)  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู

