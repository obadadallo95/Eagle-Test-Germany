# ๐ ุฃูุงู ุงุณุชุฑุฏุงุฏ ุงูุงุดุชุฑุงู

## ุงููุดููุฉ ุงูุชู ุชู ุญููุง

**ุงููุดููุฉ ุงูุฃุตููุฉ:**
- Anonymous Auth ููุดุฆ `user_id` ุฌุฏูุฏ ูู ูู ุฌูุงุฒ
- ุนูุฏ ููุฏุงู ุงูุฌูุงุฒุ ุงููุณุชุฎุฏู ุงูุฌุฏูุฏ ูู ูููู ูู ููุณ `user_id`
- **ูุง ูููู ุงุณุชุฑุฏุงุฏ ุงูุงุดุชุฑุงู ุชููุงุฆูุงู** โ

**ุงูุญู:**
- RevenueCat ูุณุชุฑุฏ ุงูุงุดุชุฑุงู ุชููุงุฆูุงู ุนุจุฑ Apple/Google Account
- ุงููุธุงู ูุชุญูู ูู ููููุฉ ุงูุงุดุชุฑุงู ูุจู ุงูุงุณุชุฑุฏุงุฏ
- **ุญูุงูุฉ ูู ุณุฑูุฉ ุงูุงุดุชุฑุงู** โ

---

## ููู ูุนูู ุงูุชุญูู ูู ุงูููููุฉ

### 1. RevenueCat Verification (ุชููุงุฆู)

```
1. ุงููุณุชุฎุฏู ูุถุบุท "ุงุณุชุนุงุฏุฉ ุงููุดุชุฑูุงุช"
   โ
2. RevenueCat ูุชุญูู ุชููุงุฆูุงู ูู Apple/Google Account
   โ
3. ุฅุฐุง ูุงู ููุณ Apple/Google Account โ โ ูุณุชุฑุฏ ุงูุงุดุชุฑุงู
   ุฅุฐุง ูุงู ุญุณุงุจ ูุฎุชูู โ โ ูุง ูุณุชุฑุฏ (ุญูุงูุฉ ูู Apple/Google)
```

### 2. Supabase Ownership Verification (ุฅุถุงูู)

```
1. ุจุนุฏ ุงุณุชุฑุฏุงุฏ ูู RevenueCat
   โ
2. ุงููุธุงู ูุชุญูู ูู Supabase:
   - ูู ูุฐุง RevenueCat customer ID ูุฑุจูุท ุจุญุณุงุจ Supabase ุขุฎุฑุ
   โ
3. ุฅุฐุง ูุงู ูุฑุจูุท ุจุญุณุงุจ ุขุฎุฑ โ โ ูุฑููุถ (ุญูุงูุฉ ุฅุถุงููุฉ)
   ุฅุฐุง ูุงู ุฌุฏูุฏ ุฃู ูุฑุจูุท ุจููุณ ุงูุญุณุงุจ โ โ ูุณููุญ
```

---

## ุงูุณููุงุฑูููุงุช

### โ ุงูุณููุงุฑูู 1: ููุณ ุงููุณุชุฎุฏูุ ุฌูุงุฒ ุฌุฏูุฏ

```
1. ุงููุณุชุฎุฏู ูุดุชุฑู ุงุดุชุฑุงู ุนูู ุงูุฌูุงุฒ ุงูุฃูู
2. ุงููุณุชุฎุฏู ูุซุจุช ุงูุชุทุจูู ุนูู ุฌูุงุฒ ุฌุฏูุฏ
3. ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู ุจููุณ Apple/Google Account
4. ุงููุณุชุฎุฏู ูุถุบุท "ุงุณุชุนุงุฏุฉ ุงููุดุชุฑูุงุช"
5. RevenueCat ูุชุญูู โ โ ููุณ Apple/Google Account
6. ุงููุธุงู ูุชุญูู ูู Supabase โ โ RevenueCat customer ID ุฌุฏูุฏ (ุฃู ูุฑุจูุท ุจููุณ ุงูุญุณุงุจ)
7. โ ุงูุงุดุชุฑุงู ูุณุชุฑุฏ
```

### โ ุงูุณููุงุฑูู 2: ูุณุชุฎุฏู ูุฎุชูู ูุญุงูู ุณุฑูุฉ ุงูุงุดุชุฑุงู

```
1. ุงููุณุชุฎุฏู A ูุดุชุฑู ุงุดุชุฑุงู
2. ุงููุณุชุฎุฏู B ูุญุงูู ุงุณุชุฑุฏุงุฏ ุงูุงุดุชุฑุงู
3. ุงููุณุชุฎุฏู B ูุณุฌู ุฏุฎูู ุจู Apple/Google Account ูุฎุชูู
4. RevenueCat ูุชุญูู โ โ Apple/Google Account ูุฎุชูู
5. โ ูุง ูุณุชุฑุฏ (ุญูุงูุฉ ูู RevenueCat)
```

### โ ุงูุณููุงุฑูู 3: ูุญุงููุฉ ุฑุจุท ุงุดุชุฑุงู ูุฑุจูุท ุจุญุณุงุจ ุขุฎุฑ

```
1. ุงููุณุชุฎุฏู A ูุดุชุฑู ุงุดุชุฑุงู (RevenueCat customer ID: "abc123")
2. ุงูุงุดุชุฑุงู ูุฑุจุท ุจู Supabase user_id: "user-a"
3. ุงููุณุชุฎุฏู B ูุญุงูู ุงุณุชุฑุฏุงุฏ ุงูุงุดุชุฑุงู
4. RevenueCat ูุชุญูู โ โ ููุณ Apple/Google Account (ูุซุงู: ููุณ Apple ID)
5. ุงููุธุงู ูุชุญูู ูู Supabase:
   - RevenueCat customer ID "abc123" ูุฑุจูุท ุจู "user-a"
   - ุงููุณุชุฎุฏู ุงูุญุงูู: "user-b"
   - โ ูุฑููุถ (ุญูุงูุฉ ูู ุงูุณุฑูุฉ)
```

---

## ุงูููุฏ

### ุงูุชุญูู ูู ุงูููููุฉ

```dart
static Future<bool> _verifySubscriptionOwnership({
  required String revenuecatCustomerId,
}) async {
  // 1. ุฅุฐุง ูุงู RevenueCat customer ID ุฌุฏูุฏ โ โ ูุณููุญ
  // 2. ุฅุฐุง ูุงู ูุฑุจูุท ุจู ููุณ Supabase user โ โ ูุณููุญ
  // 3. ุฅุฐุง ูุงู ูุฑุจูุท ุจู Supabase user ุขุฎุฑ โ โ ูุฑููุถ
}
```

### ุงุณุชุฑุฏุงุฏ ูุน ุงูุชุญูู

```dart
static Future<CustomerInfo?> restorePurchases() async {
  // 1. ุงุณุชุฑุฏุงุฏ ูู RevenueCat (ูุชุญูู ูู Apple/Google Account ุชููุงุฆูุงู)
  final customerInfo = await Purchases.restorePurchases();
  
  // 2. ุงูุชุญูู ูู ููููุฉ ุงูุงุดุชุฑุงู
  final verified = await _verifySubscriptionOwnership(
    revenuecatCustomerId: customerInfo.originalAppUserId,
  );
  
  if (!verified) {
    // โ ูุฑููุถ - ุงูุงุดุชุฑุงู ูุฏ ูููู ูุณุฑูู
    return null;
  }
  
  // โ ูุณููุญ - ุงูุงุดุชุฑุงู ูุณุชุฑุฏ ููุคูุฏ
  return customerInfo;
}
```

---

## ุงูุญูุงูุฉ ุงููุชุนุฏุฏุฉ

### 1. RevenueCat Protection (ุงููุณุชูู ุงูุฃูู)

- RevenueCat ูุชุญูู ุชููุงุฆูุงู ูู Apple/Google Account
- ูุง ูููู ุงุณุชุฑุฏุงุฏ ุงูุงุดุชุฑุงู ุจุฏูู ููุณ Apple/Google Account
- **ุญูุงูุฉ ูููุฉ ูู Apple/Google**

### 2. Supabase Ownership Check (ุงููุณุชูู ุงูุซุงูู)

- ุงููุธุงู ูุชุญูู ูู ุฃู RevenueCat customer ID ูู ูุฑุจุท ุจุญุณุงุจ Supabase ุขุฎุฑ
- ุฅุฐุง ูุงู ูุฑุจูุท ุจุญุณุงุจ ุขุฎุฑ โ ูุฑููุถ
- **ุญูุงูุฉ ุฅุถุงููุฉ ูู ุงูุณุฑูุฉ**

---

## ููุงุญุธุงุช ูููุฉ

### โ๏ธ Apple/Google Account

**ููู ุฌุฏุงู:** RevenueCat ูุนุชูุฏ ุนูู Apple/Google Account ููุงุณุชุฑุฏุงุฏ:
- **iOS:** Apple ID
- **Android:** Google Account

**ุจุฏูู Apple/Google Account:**
- ูุง ูููู ุงุณุชุฑุฏุงุฏ ุงูุงุดุชุฑุงู ุนุจุฑ ุงูุฃุฌูุฒุฉ โ
- ุงูุงุณุชุฑุฏุงุฏ ูุนูู ููุท ุนูู ููุณ ุงูุฌูุงุฒ (ุฅุฐุง ูุงู ูุญููุธุงู ูู Supabase)

### โ๏ธ Anonymous Auth

**Anonymous Auth ูุง ูุฏุนู ุงูุงุณุชุฑุฏุงุฏ ุนุจุฑ ุงูุฃุฌูุฒุฉ:**
- ูู ุฌูุงุฒ = `user_id` ุฌุฏูุฏ
- ูุง ูููู ุฑุจุท ุงูุญุณุงุจุงุช ุชููุงุฆูุงู
- **ุงูุญู:** ุงุณุชุฎุฏุงู Apple/Google Sign In (ูุณุชูุจูุงู)

---

## ุงูุชูุตูุงุช

### ููุงุณุชุฑุฏุงุฏ ุงูููุซูู ุนุจุฑ ุงูุฃุฌูุฒุฉ:

1. **ุงุณุชุฎุฏุงู Apple/Google Sign In** (ูุณุชูุจูุงู)
   - ูุฑุจุท ุงูุญุณุงุจุงุช ุนุจุฑ ุงูุฃุฌูุฒุฉ
   - RevenueCat ูุณุชุฑุฏ ุชููุงุฆูุงู
   - ุฃูุซุฑ ุฃูุงูุงู ูููุซูููุฉ

2. **ุงูุงุนุชูุงุฏ ุนูู RevenueCat** (ุงูุญุงูู)
   - RevenueCat ูุชุญูู ูู Apple/Google Account
   - ุงููุธุงู ูุชุญูู ูู ุงูููููุฉ
   - ูุนูู ุจุดูู ุฌูุฏ

3. **Email Verification** (ูุณุชูุจูุงู)
   - ุนูุฏ ุงูุงุณุชุฑุฏุงุฏุ ูุทูุจ ุงูุชุญูู ูู Email
   - ูุฑุจุท ุงูุงุดุชุฑุงู ุจู Email ุจุฏูุงู ูู Anonymous ID

---

**ุชุงุฑูุฎ:** $(date)  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู ูุน ุญูุงูุฉ ูู ุงูุณุฑูุฉ

